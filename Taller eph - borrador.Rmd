---
title: "Taller R y EPH"
author: "NIS - RLadies"
date: "2023-07-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## ¿Qué es la EPH?

La Encuesta Permanente de Hogares, la EPH, es un relevamiento estadístico que brinda información oficial sobre la situación económica, social y demográfica de la población.

Gracias a la EOH podemos conocer los datos de Pobreza e indigencia, Tasa de desempleo,distribución del ingreso y condiciones de vida de los hogares entre otros indicadores

La encuesta tiene una muestra representativa de más de 120 mil casos que se construye a partir de la Muestra Maestra Urbana de Viviendas de la República Argentina
Es un muestreo **polietápico** En la primer etapa, dentro de cada aglomerado, se selecciona una cantidad de radios censales o subdivisiones de los mismos (áreas).En la segunda etapa se listan todas las viviendas particulares de las áreas seleccionadas,para efectuar a partir de ese listado una selección aleatoria de viviendas. Los hogares que habitan esas viviendas son los hogares a encuestar. 

La encuesta se hace con una frecuencia **trimestral** con una rotación de esquema 2-2-2 
* Las viviendas de un área ingresan a la muestra para ser encuestadas en dos trimestres consecutivos, en el mes y semana asignados a ese área.
* Se retiran por dos trimestres consecutivos.
* Vuelven a la muestra para ser encuestadas en dos trimestres consecutivos en el mes y semana asignados a ese área.

En este taller vamos a aprender a:

1. Cargar los datos directamente desde nuestra consola de R usando el paquete `{eph}`
2. Manipularlos usando `dplyr` de `{tidyverse}` para observar indicadores básicos de trabajo
3. Construir una tabla usando la librería de gramática de tablas `{gt}`

## Antes de arrancar


Para poder trabajar ordenadamente te recomendamos:

Tener instaladas las librerías que vamos a usar:

```{r}
#install.packages(tidyvesre)
#install.packages(gt)
#install.packages(janitor)
#install.packages(eph)
```

Una buena práctica siempre que trabajes con **encuestas** es tener a mano:

-   Los formularios (te van a permitir entender bien la estructura y pases)
-   [El registro de diseño](https://www.indec.gob.ar/ftp/cuadros/menusuperior/eph/EPH_registro_1T2022.pdf): donde tenes la referencia del código de pregunta, estructura y en caso que corresponda las categorías posibles que tiene que adoptar.
-   Definiciones operacionales que realiza INDEC sobre condición de actividad, subocupación horaria y categoría ocupacional disponible [aquí](https://www.indec.gob.ar/ftp/cuadros/menusuperior/eph/EPH_Conceptos.pdf)

## Setup librerías

El primer paso es llamar a las librerías que vamos a usar que por lo general siempre las colocamos al principio de nuestro script

```{r setup_libraries, echo=FALSE}

library(tidyverse) # para manipular los datos
library(eph) # para levantar los datos de la encuesta 
library(janitor) # nos permite limpiar y acomodar facilmente los nombres de las variables (entre otras cosas)
library(gt) # para hermosear nuestras tablas
library(gtExtras) # para hermosear todavía más nuestras tablas 
```

## Obtener datos

Vamos a arrancar descargando los datos con la función `get_microdata()`. En este caso vamos a descargar los resultados de la base de individuos del primer trimestre de 2022. Si quisieramos especificar una serie de variables en particular con las cuales vamos a trabajar

> TIP: Para revisar los parámetros de una función siempre podemos consultar la la ayuda de R posicionándonos sobre la función y presionando la tecla F1.

```{r getdata}
ind_2023_1 <- get_microdata(
  year = 2023,
  trimester = 1,
  type = "individual",
  vars = "all",
  destfile = NA
)

```


Vamos a reproducir la tabla 1.1 del [Informe de Mercado de trabajo del primer trimestre 2023](https://www.indec.gob.ar/uploads/informesdeprensa/mercado_trabajo_eph_1trim234267B9F5D1.pdf):

Primero creamos una tabla con los siguientes indicadores de resumen:

*   Población
*   Ocupados
*   Desocupados
*   PEA
*   Ocupados demandantes
*   Subocupados (demandantes, no demandantes y total)

Estos niveles nos van a permitir calcular las tasas de forma sencilla.

Para obtener, por ejemplo la tasa de empleo, como el cociente Ocupados/Poblacion primero necesitamos calcular el total expandido por su ponderación de la **población** y los **ocupados**.

Vamos a trabara con las variables:
PONDERA: Que es el factor de expansión para cada unidad de análisis
ESTADO: Que indica la condición de actividad y puede tomar los valores: 
        0 = Entrevista individual no realizada (no respuesta al cuestionario individual)
        1 = Ocupado
        2 = Desocupado
        3 = Inactivo
        4 = Menor de 10 años
PP03J: Que es la pregunta: Aparte de este/os trabajo/s, ¿estuvo buscando algún empleo / ocupación /actividad? y que toma los valores: 
       1 = Sí
       2 = No
       9 = Ns/Nr




Con la función `summarise` del paquete `{tidyerse}` podemos realizar distintas operaciones de resumen sobre las variables de nuestra base:

*   *Poblacion:* son la cantidad de personas que tiene la base es decir simplemente sumamos los valores de la variable PONDERA que nos dice cuánto "pesa" cada persona en la representación muestral.
*   *Ocupación:* En este caso, debemos agregar un filtro sobre la población, ya que solo queremos sumar los ponderadores de aquellas personas que se encuentran ocupadas. Esto lo hacemos indicando entre corchete [] el (La lógica seria: “Suma los valores de la columna PONDERA, solo para aquellos registros donde el ESTADO == 1”)
*   *Desocupacion:* Con una lógica similar a la de Ocupación filtramos los casos que en la variable *ESTADO* tienen la categoría 2
*   *PEA:*(Población Económicamente Activa): es igual a la suma de la Población Ocupada y la desocupada.
*   Personas ocupadas demanadantes: 


```{r}
tabla_1 <- ind_2023_1 |> 
  summarise(Poblacion          = sum(PONDERA),
            Ocupacion          = sum(PONDERA[ESTADO == 1]),
            Desocupacion       = sum(PONDERA[ESTADO == 2]),
            PEA                = Ocupacion + Desocupacion,
            Ocupacion_demandate = sum(PONDERA[ESTADO == 1 & PP03J ==1]),
            Suboc_demandante   = sum(PONDERA[ESTADO == 1 & INTENSI ==1 & PP03J==1]),
            Suboc_no_demand    = sum(PONDERA[ESTADO == 1 & INTENSI ==1 & PP03J %in% c(2,9)]),
            Subocupacion       = Suboc_demandante + Suboc_no_demand)

tabla_1
```

Ahora vamos a calcular las tasas creando una serie de nuevas columnas, usando la función `mutate`

```{r}
tabla_1 <- tabla_1 |> 
  mutate('Actividad'                  = PEA/Poblacion,
         'Empleo'                     = Ocupacion/Poblacion,
         'Desocupación'               = Desocupacion/PEA,
         'Ocupación demandante'       = Ocupacion_demandate/PEA,
         'Subocupación'               = Subocupacion/PEA,
         'Subocupación demandante'    = Suboc_demandante/PEA,
         'Subocupación no demandante' = Suboc_no_demand/PEA)

tabla_1
```



Y ahora nos vamos a quedar solamente con las variables de las tasas seleccionándolas con la función `select`

```{r}
tabla_1 <- tabla_1 |> 
  select(Actividad:'Subocupación no demandante')

tabla_1
```


Ya tenemos los datos que necesitamos pero parece que la tabla estuviera "acostada". Para que se ponga de pie o estire a lo largo vamos a usar la función `pivot_longer`

```{r}
tabla_1 <- tabla_1 |> 
  pivot_longer(cols = everything(), #Las columnas que queremos estirar en este caso son todas 
               names_to = "Tasas", # El nombre que le queremos poner
               values_to = "Valor") # el valor en cuestión que hay que repartir


tabla_1

```

Solo nos queda multiplicar por 100 el valor de la tasa, el cual redondeamos a un decimal

```{r}
tabla_1 <- tabla_1 |> 
  mutate(Valor = round(Valor*100,1))

tabla_1
```


>  Las funciones pivot_longer y pivot_wider nos ayudan a estirar y alargar los datos para saber más sobre ellas te resomendamos la lectura de [esta viñeta](https://tidyr.tidyverse.org/articles/pivot.html) donde vas a encontrar varios ejemplos.


Ahora vamos a darle un estilo lo más parecido posible al del Informe técnico que hace INDEC


<!-- AIUDAAAAA -->

```{r}

tabla_1 |> 
  gt() |> 
  tab_header(title = "Principales tasas del mercado de trabajo. Total 31 aglomerados urbanos.
Primer trimestre 2022-primer trimestre 2023") |> 
  opt_table_font(
    font = list(
      google_font(name = "Montserrat"),
      labels = list(
        title = list(weight = "bold", size = 9),
        header = list(weight = "bold", size = 8),
        footnote = list(weight = "bold", size = 8),
        source = list(weight = "bold", size = 8)
      )
    )
  ) |> 
  cols_align(
    align = "right",
    columns = Valor
  ) |> 
  tab_footnote('Fuente: INDEC, Encuesta Permanente de Hogares.')
  
  

```



```{r}
tabla_1 |> 
  mutate(Grafico = Valor) |> 
  gt() |> 
  tab_header(title = "Principales tasas del mercado de trabajo. Total 31 aglomerados urbanos.
Primer trimestre 2022-primer trimestre 2023") |> 
  opt_table_font(
    font = list(
      google_font(name = "Montserrat"),
      labels = list(
        title = list(weight = "bold", size = 9),
        header = list(weight = "bold", size = 8),
        footnote = list(weight = "bold", size = 8),
        source = list(weight = "bold", size = 8)
      )
    )
  ) |> 
  cols_align(
    align = "right",
    columns = Valor
  ) |> 
  tab_footnote('Fuente: INDEC, Encuesta Permanente de Hogares.') |> 
  gtExtras::gt_plt_bar(column = Grafico, scaled = TRUE,  fill = "blue", background = "lightblue")
  
```





<!-- ESTA PARTE VER SI LLEGAMOS QUIZAS ES MUCHO -->



## Relacionar hogares e individuos

Veamos la relación entre las condiciones de pobreza  y el nivel educativo

Traigamos las bases del primer y segundo trimestre de ambos formularios

```{r}
ind_2022 <- get_microdata(year = 2022,
                            trimester = c(1,2,3,4),
                            type = 'individual') 

hog_2022_1_2 <- get_microdata(year = 2022,
                            trimester = c(1,2,3,4),
                            type = 'hogar') 

```
vamos a unir ambas bases usando la función left_join

```{r}
eph_2022 <- ind_2022 |> 
  left_join(hog_2022_1_2)

# aca ver que cuando los joineamos ya etiquetados no joinea 
```
R nos informa que ha unido las bases por las variables que tienen en común: CODUSU, NRO_HOGAR, ANO4, TRIMESTRE, PONDERA.

```{r}
eph_2022 |> 
  group_by(TRIMESTRE) |>  #agrupamos por trimestre
  tally(PONDERA) 
```
```{r}
eph_2022 |> 
  filter(CH03==1) |>  #Nos quedamos con las jefaturas de hogar
  group_by(TRIMESTRE) |> 
  tally(PONDERA)
```

Gracias al paquete EPH nos bajamos las canastas de pobreza


```{r}
# obtener las canastas regionales
canastas_regionales <- get_poverty_lines(regional = TRUE)
# calculo de la condición de pobreza para la población
eph_2022 <- calculate_poverty(eph_2022, canastas_regionales, print_summary = TRUE)
```

Nos arma una nueva columna llamada **situación** lo que nos indica en qué medida los hogares cubren o no sus necesidades básicas. 


```{r}
eph_2022 |> 
  group_by(situacion) |> 
  tally(PONDIH/2) |>  #promedio por los dos trimestres
  filter(!is.na(situacion)) |> 
  mutate(total_personas=sum(n)) |> 
  mutate(prop = round(n/total_personas*100,2)) |> 
  rename(personas=n)
```
pobreza según nivel educativo

Etiquetar nivel educativo

```{r}

```

Armar la tabla

```{r}

tabla_2 <- eph_2022 |> 
  group_by(situacion,nivel_educativo = (as.factor(NIVEL_ED))) |> 
  tally(PONDIH/2) |>  #promedio por los dos trimestres
  filter(!is.na(situacion)) |> 
  mutate(total_personas=sum(n)) |> 
  mutate(prop = round(n/total_personas*100,2)) |> 
  rename(personas=n)

tabla_2

```
Graficar

```{r}

library(plotly)

plot_ly(tabla_2, x = ~nivel_educativo, y = ~prop, type = 'bar', color = ~situacion) %>%
  layout(
    title = "Porcentaje de Pobreza por Nivel Educativo",
    xaxis = list(title = "Nivel Educativo"),
    yaxis = list(title = "Porcentaje de Pobreza")
  )

```